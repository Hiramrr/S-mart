<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: stores/ventas.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: stores/ventas.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { defineStore } from 'pinia'
import { supabase } from '@/lib/supabase.js' //
import { useAuthStore } from './auth' //
import { ref } from 'vue'

/**
 * @typedef {object} VentaProducto
 * @property {number} producto_id - El ID del producto.
 * @property {string} nombre - El nombre del producto.
 * @property {number} cantidad - La cantidad vendida.
 * @property {number} precio - El precio unitario del producto en esta venta.
 * @property {string|null} imagen_url - La URL de la imagen del producto.
 */

/**
 * @typedef {object} SeguimientoEstado
 * @property {string} estado - El estado actual del env√≠o (e.g., 'Pendiente', 'Enviado').
 * @property {string} fecha - La fecha en formato ISO en que se actualiz√≥ el estado.
 */

/**
 * @typedef {object} VentaEnLinea
 * @property {string} cliente_id - El ID del cliente que realiz√≥ la compra.
 * @property {string} vendedor_id - El ID del vendedor al que se le compr√≥.
 * @property {VentaProducto[]} productos - Array de productos incluidos en esta venta.
 * @property {number} monto_total - El monto total de la venta para este vendedor.
 * @property {string} metodo_pago - El m√©todo de pago utilizado.
 * @property {number} direccion_id - El ID de la direcci√≥n de env√≠o.
 * @property {string} fecha_estimada_entrega - La fecha estimada de entrega en formato ISO.
 * @property {SeguimientoEstado[]} seguimiento - El historial de seguimiento del env√≠o.
 */

/**
 * Store para la gesti√≥n de ventas, tanto en punto de venta (POS) como en l√≠nea.
 *
 * @exports useVentasStore
 */
export const useVentasStore = defineStore('ventas', () => {
  /**
   * Almacena los detalles de la √∫ltima venta realizada para poder mostrarlos en una vista de confirmaci√≥n.
   * @type {import('vue').Ref&lt;any|null>}
   */
  const ultimaVentaDetalles = ref(null)

  /**
   * Registra una nueva venta en el sistema de Punto de Venta (POS).
   * @param {object[]} productos - Los productos vendidos.
   * @param {number} total - El monto total de la venta.
   * @param {string} metodoPago - El m√©todo de pago (e.g., 'efectivo', 'tarjeta').
   * @returns {Promise&lt;any>} Los datos de la venta registrada.
   * @async
   */
  async function crearVentaPOS(productos, total, metodoPago) {
    const authStore = useAuthStore()
    if (!authStore.usuario) throw new Error('Cajero no autenticado')

    console.log('Registrando venta POS...')
    const { data, error } = await supabase
      .from('purchase_history')
      .insert({
        cashier_id: authStore.usuario.id,
        products: productos,
        total_amount: total,
        payment_method: metodoPago,
      })
      .select()

    if (error) {
      console.error('Error al registrar venta POS:', error)
      throw error
    }

    console.log('Venta POS registrada:', data)
    return data
  }

  /**
   * Registra una o m√°s ventas en l√≠nea a partir de los items de un carrito.
   * Agrupa los productos por vendedor y crea una venta separada para cada uno.
   * @param {import('./cartStore').CartItem[]} itemsDelCarrito - Los items que se van a comprar.
   * @param {string} metodoPago - El m√©todo de pago utilizado.
   * @param {number} direccionId - El ID de la direcci√≥n de env√≠o del cliente.
   * @returns {Promise&lt;VentaEnLinea[]>} Un array con los datos de las ventas registradas.
   * @async
   */
  async function crearVentaEnLinea(itemsDelCarrito, metodoPago, direccionId) {
    const authStore = useAuthStore()
    if (!authStore.usuario) throw new Error('Cliente no autenticado')

    // 1. Calcular fecha de entrega
    const hoy = new Date()
    const fechaEntrega = new Date(hoy)
    fechaEntrega.setDate(hoy.getDate() + 7)
    const fechaEstimadaISO = fechaEntrega.toISOString().split('T')[0]

    // 2. Agrupar productos por vendedor_id
    const ventasPorVendedor = new Map()

    for (const item of itemsDelCarrito) {
      const vendedorId = item.vendedor_id

      if (!vendedorId) {
        console.warn('Producto sin vendedor_id en el carrito:', item)
        continue
      }

      // Debug: Verificar datos del item
      console.log('üì¶ Procesando item del carrito:', {
        id: item.id,
        name: item.name,
        precio: item.precio,
        price: item.price,
        imageUrl: item.imageUrl,
        imagen_url: item.imagen_url,
        vendedor_id: item.vendedor_id,
      })

      if (!ventasPorVendedor.has(vendedorId)) {
        ventasPorVendedor.set(vendedorId, {
          productos: [],
          monto_total: 0,
        })
      }

      const venta = ventasPorVendedor.get(vendedorId)

      // Obtener el precio correcto del item del carrito
      const precioNumerico = parseFloat(item.precio || item.price || 0)

      venta.productos.push({
        producto_id: item.id,
        nombre: item.name,
        cantidad: item.cantidad,
        precio: precioNumerico,
        imagen_url: item.imageUrl || item.imagen_url || null,
      })

      // Validar que el precio sea v√°lido
      if (isNaN(precioNumerico) || precioNumerico &lt;= 0) {
        console.warn(`Producto ${item.name} tiene precio inv√°lido o 0:`, item)
      }

      venta.monto_total += precioNumerico * item.cantidad
    }

    // 3. Crear un array de registros para insertar
    const registrosDeVenta = []
    const clienteId = authStore.usuario.id

    for (const [vendedorId, venta] of ventasPorVendedor.entries()) {
      registrosDeVenta.push({
        cliente_id: clienteId,
        vendedor_id: vendedorId,
        productos: venta.productos,
        monto_total: venta.monto_total, // &lt;-- Esto ahora ser√° un N√öMERO
        metodo_pago: metodoPago,
        direccion_id: direccionId,
        fecha_estimada_entrega: fechaEstimadaISO,
        seguimiento: [{ estado: 'Pendiente', fecha: new Date().toISOString() }],
      })
    }

    // 4. Insertar todos los registros en la BD
    console.log('Registrando ventas en l√≠nea:', registrosDeVenta)
    const { data, error } = await supabase.from('venta_en_linea').insert(registrosDeVenta).select()

    if (error) {
      console.error('Error al registrar venta en l√≠nea:', error)
      throw error
    }

    console.log('Ventas en l√≠nea registradas:', data)
    return data
  }

  /**
   * Establece los detalles de la √∫ltima venta para que puedan ser accedidos por otros componentes.
   * @param {any} detalles - Los detalles de la venta a almacenar.
   */
  function setUltimaVenta(detalles) {
    ultimaVentaDetalles.value = detalles
  }

  return {

    crearVentaPOS,
    crearVentaEnLinea,
    ultimaVentaDetalles, // &lt;-- Exponer el estado
    setUltimaVenta,
  }
})
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-useAuthStore.html">useAuthStore</a></li><li><a href="module-useCartStore.html">useCartStore</a></li><li><a href="module-useChat.html">useChat</a></li><li><a href="module-useCounterStore.html">useCounterStore</a></li><li><a href="module-useCreditCardFormatters.html">useCreditCardFormatters</a></li><li><a href="module-useNotificationStore.html">useNotificationStore</a></li><li><a href="module-usePaymentCheckout.html">usePaymentCheckout</a></li><li><a href="module-useProductStore.html">useProductStore</a></li><li><a href="module-useRole.html">useRole</a></li><li><a href="module-useTicketGenerator.html">useTicketGenerator</a></li><li><a href="module-useVentasStore.html">useVentasStore</a></li></ul><h3>Global</h3><ul><li><a href="global.html#LOW_STOCK_THRESHOLD">LOW_STOCK_THRESHOLD</a></li><li><a href="global.html#history">history</a></li><li><a href="global.html#redirectUrl">redirectUrl</a></li><li><a href="global.html#router">router</a></li><li><a href="global.html#routes">routes</a></li><li><a href="global.html#scrollBehavior">scrollBehavior</a></li><li><a href="global.html#subirImagenCloudinary">subirImagenCloudinary</a></li><li><a href="global.html#supabase">supabase</a></li><li><a href="global.html#supabaseAnonKey">supabaseAnonKey</a></li><li><a href="global.html#supabaseUrl">supabaseUrl</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Sat Nov 29 2025 17:14:20 GMT-0600 (hora est√°ndar central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
